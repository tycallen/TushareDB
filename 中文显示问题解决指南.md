# 中文显示问题解决指南

## 问题描述

在使用市场宽度图时，如果图表中的中文显示为方框（□□□）或乱码，说明 matplotlib 的中文字体配置有问题。

## 已实施的解决方案

代码已经自动配置了中文字体支持，会按照以下优先级自动选择可用的中文字体：

### 字体优先级列表

1. **PingFang SC** - macOS 苹方（简体中文）
2. **PingFang HK** - macOS 苹方（香港）✓ 当前系统使用
3. **PingFang TC** - macOS 苹方（繁体中文）
4. **Heiti SC** - macOS 黑体（简体中文）
5. **Heiti TC** - macOS 黑体（繁体中文）
6. **STHeiti** - macOS 华文黑体
7. **Songti SC** - macOS 宋体
8. **Kaiti SC** - macOS 楷体
9. **Microsoft YaHei** - Windows 微软雅黑
10. **SimHei** - Windows 黑体
11. **WenQuanYi Micro Hei** - Linux 文泉驿微米黑
12. **Noto Sans CJK SC** - Linux Noto 字体

## 快速测试

### 方法1：运行测试脚本

```bash
python test_chinese_display.py
```

这会生成一个测试图片 `market_width_test.png`，打开查看中文是否正常显示。

### 方法2：运行字体检查工具

```bash
python check_chinese_font.py
```

这个工具会：
- 列出系统中所有可用的中文字体
- 推荐最佳字体
- 生成测试图表
- 提供详细的诊断信息

## 常见问题和解决方案

### 问题1：中文显示为方框 □□□

**原因**：系统没有安装中文字体，或 matplotlib 无法找到中文字体

**解决方案**：

#### macOS 系统
```bash
# 检查系统字体
ls /System/Library/Fonts/*.ttc
ls ~/Library/Fonts/

# 如果没有中文字体，从 App Store 下载"字体册"应用
# 或者安装开源字体
brew install font-noto-sans-cjk
```

#### Windows 系统
```bash
# 确保已安装微软雅黑或黑体
# 通常 Windows 系统自带这些字体
# 如果没有，可以从控制面板 -> 字体 安装

# 或者手动指定字体
python -c "import matplotlib.pyplot as plt; plt.rcParams['font.sans-serif'] = ['Microsoft YaHei']"
```

#### Linux 系统
```bash
# Ubuntu/Debian
sudo apt-get install fonts-wqy-microhei fonts-wqy-zenhei

# Fedora/CentOS
sudo yum install wqy-microhei-fonts wqy-zenhei-fonts

# 清除 matplotlib 缓存
rm -rf ~/.cache/matplotlib
```

### 问题2：部分中文正常，部分显示为方框

**原因**：选择的字体不支持某些中文字符

**解决方案**：

1. 手动指定字体：

```python
from market_width import setup_chinese_font

# 显示当前使用的字体
setup_chinese_font(verbose=True)
```

2. 修改 `market_width.py` 中的字体优先级

### 问题3：matplotlib 警告字体未找到

**解决方案**：

```bash
# 清除 matplotlib 缓存
rm -rf ~/.matplotlib
rm -rf ~/.cache/matplotlib

# 重新生成字体缓存
python -c "import matplotlib.font_manager; matplotlib.font_manager._rebuild()"
```

### 问题4：在 Jupyter Notebook 中显示异常

**解决方案**：

```python
# 在 notebook 第一个单元格执行
%matplotlib inline
from market_width import setup_chinese_font
setup_chinese_font(verbose=True)

# 重启 kernel 后重新运行
```

## 手动配置字体

如果自动配置不起作用，可以手动指定字体：

### 方法1：修改代码

在导入模块后添加：

```python
import matplotlib.pyplot as plt

# macOS
plt.rcParams['font.sans-serif'] = ['PingFang HK']

# Windows
plt.rcParams['font.sans-serif'] = ['Microsoft YaHei']

# Linux
plt.rcParams['font.sans-serif'] = ['WenQuanYi Micro Hei']

plt.rcParams['axes.unicode_minus'] = False
```

### 方法2：创建 matplotlib 配置文件

创建或编辑 `~/.matplotlib/matplotlibrc` 文件：

```ini
# macOS
font.sans-serif : PingFang HK, Heiti TC, STHeiti

# Windows
font.sans-serif : Microsoft YaHei, SimHei

# Linux
font.sans-serif : WenQuanYi Micro Hei, Noto Sans CJK SC

axes.unicode_minus : False
```

### 方法3：使用环境变量

```bash
# 设置 matplotlib 后端
export MPLBACKEND=Agg

# 运行脚本
python market_width_quickstart.py
```

## 检查当前字体配置

运行以下命令查看当前使用的字体：

```python
import matplotlib.pyplot as plt
print("当前字体:", plt.rcParams['font.sans-serif'])
```

## 查看系统可用字体

运行以下脚本列出所有可用的中文字体：

```python
import matplotlib.font_manager as fm

chinese_keywords = ['Hei', 'Song', 'Kai', 'Fang', 'PingFang', 'Microsoft']
fonts = set()

for f in fm.fontManager.ttflist:
    if any(kw in f.name for kw in chinese_keywords):
        fonts.add(f.name)

print("可用的中文字体:")
for font in sorted(fonts):
    print(f"  - {font}")
```

## 验证修复

修复后，运行以下命令验证：

```bash
# 快速测试
python test_chinese_display.py

# 完整检查
python check_chinese_font.py

# 运行实际程序
python market_width_quickstart.py
```

## 获取帮助

如果以上方法都无法解决问题，请提供以下信息：

1. 操作系统和版本
2. Python 版本
3. matplotlib 版本：`python -c "import matplotlib; print(matplotlib.__version__)"`
4. 运行 `python check_chinese_font.py` 的完整输出
5. 生成的测试图片

## 相关资源

- [matplotlib 中文显示官方文档](https://matplotlib.org/stable/tutorials/text/text_props.html)
- [matplotlib 字体配置](https://matplotlib.org/stable/tutorials/introductory/customizing.html#matplotlibrc-sample)
- [macOS 字体管理](https://support.apple.com/zh-cn/guide/font-book/welcome/mac)

---

**更新日期**: 2025-12-26
**当前系统字体**: PingFang HK
**状态**: ✓ 已配置并测试通过
