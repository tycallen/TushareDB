# 市场宽度图实现总结

## 📁 创建的文件列表

### 核心文件

1. **`market_width.py`** - 核心实现模块
   - 包含所有市场宽度计算和可视化函数
   - 可作为库导入使用
   - 也可直接运行查看示例

2. **`market_width_quickstart.py`** - 快速开始脚本 ⭐ 推荐
   - 一键运行即可生成市场宽度分析
   - 包含详细的统计信息输出
   - 最适合日常使用

3. **`market_width_example.py`** - 示例集合
   - 包含4个不同场景的使用示例
   - 演示各种参数组合和分析方法

4. **`test_market_width.py`** - 测试脚本
   - 用于验证代码功能
   - 不显示图形，只输出数据

### 文档文件

5. **`MARKET_WIDTH_README.md`** - 完整使用文档
   - 详细的功能说明和参数解释
   - 丰富的使用示例
   - 数据解读指南
   - 常见问题解答

6. **`市场宽度图实现总结.md`** - 本文件
   - 项目总结和快速参考

## 🚀 快速开始

### 方式1：一键运行（最简单）

```bash
python market_width_quickstart.py
```

这将：
- 自动连接数据库
- 分析最近60个交易日的市场宽度
- 显示详细统计信息
- 生成可视化图表

### 方式2：在代码中使用

```python
from tushare_db import DataReader
from market_width import get_industry_width, show_industry_width
import datetime

# 初始化
reader = DataReader()

# 获取数据
df = get_industry_width(reader, datetime.date(2025, 12, 16), days=60)

# 显示图表
show_industry_width(df, count=30)

# 关闭连接
reader.close()
```

## 📊 功能特性

### 1. 核心功能

- ✅ **行业宽度计算**：计算每个行业中上涨股票的占比
- ✅ **市场总分**：汇总所有行业的宽度，反映市场整体强弱
- ✅ **热力图可视化**：直观展示行业轮动和市场趋势
- ✅ **趋势图**：显示市场总分的时间序列变化

### 2. 数据处理

- ✅ 自动过滤小市值行业（可自定义阈值）
- ✅ 自动处理缺失数据
- ✅ 支持自定义日期范围
- ✅ 高性能 DuckDB 查询

### 3. 分析工具

- ✅ 强势/弱势行业识别
- ✅ 市场趋势对比（近期 vs 前期）
- ✅ 行业持续性分析
- ✅ 统计指标计算

## 🎯 主要参数说明

### get_industry_width() 参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `reader` | DataReader | 必填 | 数据库连接对象 |
| `end_date` | str/date | 必填 | 结束日期 |
| `days` | int | 必填 | 统计的交易日数量 |
| `min_stocks_per_industry` | int | 20 | 行业最少股票数 |

### show_industry_width() 参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `df` | DataFrame | 必填 | 市场宽度数据 |
| `count` | int | None | 显示的交易日数量 |

## 📈 输出解读

### 热力图

- **横轴**：各个行业
- **纵轴**：交易日期
- **颜色**：
  - 🔴 红色（50-100）：行业强势，上涨股票多
  - 🔵 蓝色（0-50）：行业弱势，下跌股票多
- **最右列**：市场总分，反映整体强弱

### 统计指标

- **平均值**：期间市场平均强度
- **最高/低值**：市场最强/弱的时刻
- **标准差**：市场波动程度
- **行业平均占比**：各行业的平均表现

## 🔧 高级用法

### 1. 分析特定行业

```python
# 只关注科技相关行业
df = get_industry_width(reader, end_date, days=60, min_stocks_per_industry=50)
tech_industries = ['软件服务', '半导体', 'IT设备', '通信设备']
tech_df = df[tech_industries + ['总分']]
```

### 2. 导出数据

```python
# 保存为 CSV
df.to_csv('market_width_data.csv', encoding='utf-8-sig')

# 保存为 Excel
df.to_excel('market_width_data.xlsx')
```

### 3. 自定义分析

```python
# 计算行业相关性
correlation = df.drop(columns=['总分']).corr()

# 找出当前最强行业
latest_day = df.iloc[-1].drop('总分').sort_values(ascending=False)
print("当前最强行业:", latest_day.head(5))

# 找出持续强势的行业
strong_days = (df.drop(columns=['总分']) > 60).sum()
persistent = strong_days[strong_days > len(df) * 0.7]
print("持续强势行业:", persistent)
```

## 📋 使用场景

### 1. 日常市场监控

```bash
# 每天收盘后运行
python market_width_quickstart.py
```

### 2. 周度/月度复盘

```python
# 查看本周/本月市场宽度变化
df = get_industry_width(reader, datetime.date.today(), days=5)  # 本周
df = get_industry_width(reader, datetime.date.today(), days=20) # 本月
```

### 3. 行业轮动研究

```python
# 对比不同时期的行业表现
df_recent = df.tail(10).drop(columns=['总分']).mean()
df_previous = df.iloc[-20:-10].drop(columns=['总分']).mean()
rotation = df_recent - df_previous
print("行业轮动情况:", rotation.sort_values(ascending=False))
```

### 4. 策略开发

```python
# 基于市场宽度的择时信号
if df['总分'].iloc[-1] > df['总分'].mean() + df['总分'].std():
    print("市场强势，可以加仓")
elif df['总分'].iloc[-1] < df['总分'].mean() - df['总分'].std():
    print("市场弱势，建议减仓")
```

## ⚠️ 注意事项

### 数据要求

1. 需要初始化以下数据表：
   - `stock_basic` - 股票基本信息
   - `pro_bar` - 日线行情数据
   - `trade_cal` - 交易日历

2. 如果缺少数据，运行：
```bash
python scripts/init_data.py
```

### 性能优化

- 分析长时间范围时（200+天），建议增大 `min_stocks_per_industry`
- 首次运行可能较慢，后续查询会利用数据库缓存
- 图表显示大量数据时可能较慢，建议使用 `count` 参数限制显示天数

### 常见问题

1. **Q: 为什么有些行业不显示？**
   - A: 被 `min_stocks_per_industry` 参数过滤了，可以降低阈值

2. **Q: 图表无法显示**
   - A: 检查是否安装了 matplotlib 和 seaborn，或使用测试脚本

3. **Q: 日期范围内没有数据**
   - A: 检查数据库中的数据日期范围，确保请求的日期有数据

4. **Q: 计算速度慢**
   - A: 减少 `days` 参数，或增大 `min_stocks_per_industry`

## 📚 扩展阅读

- 原始代码基于 JQData 实现，本版本完全基于 Tushare-DuckDB
- 市场宽度是技术分析中的重要指标，与大盘指数互为补充
- 建议结合成交量、资金流向等指标综合分析

## 🔄 更新计划

- [ ] 支持自定义行业分类（如申万一级/二级）
- [ ] 添加板块宽度分析（概念板块、地域板块）
- [ ] 支持指数成分股宽度分析
- [ ] 添加市场宽度预警功能
- [ ] 生成 HTML 报告

## 📞 反馈与支持

如有问题或建议，欢迎提交 Issue 或 Pull Request。

---

**创建日期**: 2025-12-26
**版本**: 1.0.0
**基于**: Tushare-DuckDB 项目
