# 筹码与因子数据质量检查报告

**生成时间**: 2026-01-31
**数据库路径**: `/Users/allen/workspace/python/stock/Tushare-DuckDB/tushare.db`

---

## 一、数据概览

### 1.1 各表基本信息

| 表名 | 记录数 | 股票数 | 交易日数 | 起始日期 | 结束日期 |
|------|--------|--------|----------|----------|----------|
| cyq_chips | 37,635,784 | 5,681 | 639 | 20230228 | 20251017 |
| cyq_perf | 8,629,539 | 5,731 | 1,961 | 20180102 | 20260130 |
| stk_factor_pro | 14,870,710 | 5,418 | 6,185 | 20000104 | 20250714 |
| daily | 16,486,059 | 5,795 | 6,321 | 20000104 | 20260130 |

### 1.2 表结构说明

**cyq_chips (筹码分布)**:
- `ts_code`: 股票代码
- `trade_date`: 交易日期
- `price`: 价格点
- `percent`: 该价格点的筹码占比

**cyq_perf (筹码绩效)**:
- `ts_code`, `trade_date`: 主键
- `his_low`, `his_high`: 历史最低/最高
- `cost_5pct`, `cost_15pct`, `cost_50pct`, `cost_85pct`, `cost_95pct`: 成本分位数
- `weight_avg`: 加权平均成本
- `winner_rate`: 获利比例(%)

**stk_factor_pro (技术因子)**:
- 共261个字段，包含bfq/hfq/qfq三种复权方式
- 主要因子: MA, MACD, RSI, KDJ, BOLL, ATR, CCI, OBV等

---

## 二、重复数据检查

| 表名 | 主键定义 | 重复记录数 | 状态 |
|------|----------|------------|------|
| cyq_chips | ts_code + trade_date + price | 0 | 正常 |
| cyq_perf | ts_code + trade_date | 0 | 正常 |
| stk_factor_pro | ts_code + trade_date | 0 | 正常 |

**结论**: 所有表无重复数据，主键唯一性良好。

---

## 三、空值率统计

### 3.1 cyq_chips 空值率

| 字段 | 总记录数 | 空值数 | 空值率 |
|------|----------|--------|--------|
| ts_code | 37,635,784 | 0 | 0.00% |
| trade_date | 37,635,784 | 0 | 0.00% |
| price | 37,635,784 | 0 | 0.00% |
| percent | 37,635,784 | 0 | 0.00% |

### 3.2 cyq_perf 空值率

| 字段 | 总记录数 | 空值数 | 空值率 |
|------|----------|--------|--------|
| ts_code | 8,629,539 | 0 | 0.00% |
| trade_date | 8,629,539 | 0 | 0.00% |
| his_low | 8,629,539 | 0 | 0.00% |
| his_high | 8,629,539 | 0 | 0.00% |
| cost_5pct | 8,629,539 | 0 | 0.00% |
| cost_15pct | 8,629,539 | 0 | 0.00% |
| cost_50pct | 8,629,539 | 0 | 0.00% |
| cost_85pct | 8,629,539 | 0 | 0.00% |
| cost_95pct | 8,629,539 | 0 | 0.00% |
| weight_avg | 8,629,539 | 0 | 0.00% |
| winner_rate | 8,629,539 | 0 | 0.00% |

### 3.3 stk_factor_pro 空值率

| 字段 | 空值数 | 空值率 | 说明 |
|------|--------|--------|------|
| ts_code | 0 | 0.00% | - |
| trade_date | 0 | 0.00% | - |
| close | 0 | 0.00% | - |
| vol | 0 | 0.00% | - |
| obv_bfq | 0 | 0.00% | - |
| macd_dif_bfq | 0 | 0.00% | - |
| rsi_bfq_6 | 4,946 | 0.03% | 初始计算期 |
| kdj_k_bfq | 37,298 | 0.25% | 初始计算期 |
| cci_bfq | 60,571 | 0.41% | 初始计算期 |
| turnover_rate | 86,894 | 0.58% | 部分股票缺失 |
| ma_bfq_5 | 18,614 | 0.13% | 初始4天 |
| ma_bfq_20 | 88,423 | 0.59% | 初始19天 |
| ma_bfq_60 | 274,589 | 1.85% | 初始59天 |
| atr_bfq | 93,076 | 0.63% | 初始计算期 |
| ma_bfq_250 | 1,155,933 | 7.77% | 初始249天 |

**说明**: 技术因子的空值主要是由于计算周期导致的初始期数据缺失，属于正常现象。

---

## 四、筹码数据合理性检查

### 4.1 cyq_chips 数据范围

| 检查项 | 最小值 | 最大值 | 平均值 | 异常数 |
|--------|--------|--------|--------|--------|
| percent (筹码占比) | 0.0 | 90.14 | 1.42 | 0 (范围0-100%) |
| price (价格) | 0.0 | 2335.3 | 27.06 | 181 (price=0) |

**异常详情**:
- **price=0 的记录**: 181条，全部为 600436.SH (片仔癀) 在2025年9-10月的数据
- 可能原因: 数据源在特定时段的价格点记录异常

### 4.2 筹码占比总和检查

| 指标 | 值 |
|------|-----|
| 总股票日数 | 533,540 |
| 异常记录数 (占比不在99%-101%范围) | 9,232 |
| 异常率 | 1.73% |
| 最小总占比 | 0.01% |
| 最大总占比 | 199.96% |
| 平均总占比 | 100.08% |

**异常分类**:
1. **占比过高 (~200%)**: 主要是 688063.SH 在2025年8-9月，可能存在数据重复
2. **占比过低 (<50%)**: 分散在多只股票，可能是数据不完整或停牌导致

### 4.3 cyq_perf 获利比例检查

| 检查项 | 最小值 | 最大值 | 平均值 | 异常数 |
|--------|--------|--------|--------|--------|
| winner_rate | 0.0 | 100.62 | 43.51 | 6,550 (>100) |

**异常说明**: 有6,550条记录的winner_rate超过100%，最高达100.62%
- 可能原因: 浮点计算精度问题或数据源异常
- 影响范围: 0.076%的数据
- 典型案例: 300206.SZ(20200707), 000921.SZ(20230417) 等

### 4.4 成本数据合理性

| 字段 | 最小值 | 最大值 | 平均值 | 无效(<=0)数 |
|------|--------|--------|--------|-------------|
| cost_5pct | 0.0 | 1792.5 | 15.75 | 15 |
| cost_50pct | 0.0 | 2222.7 | 18.03 | 7 |
| cost_95pct | 0.2 | 2294.4 | 21.04 | 0 |
| weight_avg | 0.15 | 2133.57 | 18.21 | 0 |

**成本递增逻辑检查**:
- 检查条件: cost_5pct <= cost_15pct <= cost_50pct <= cost_85pct <= cost_95pct
- 异常记录数: 0
- **结论**: 成本分位数数据逻辑一致性良好

---

## 五、因子数据检查

### 5.1 RSI、KDJ、WR 指标范围 (应为0-100)

| 因子 | 最小值 | 最大值 | 平均值 | 越界数 |
|------|--------|--------|--------|--------|
| rsi_bfq_6 | 0.0 | 100.0 | 49.19 | 0 |
| rsi_bfq_12 | 0.0 | 100.0 | 49.11 | 0 |
| rsi_bfq_24 | 0.0 | 100.0 | 49.11 | 0 |
| wr_bfq | 0.0 | 100.0 | 52.52 | 0 |
| kdj_k_bfq | 0.0 | 100.0 | 47.63 | 0 |
| kdj_d_bfq | 0.0 | 100.0 | 47.62 | 0 |

**结论**: 所有限界指标均在有效范围内

### 5.2 MACD、MA、BOLL 指标范围

| 因子 | 最小值 | 最大值 | 平均值 |
|------|--------|--------|--------|
| macd_dif_bfq | -128.57 | 155.75 | -0.03 |
| macd_dea_bfq | -111.52 | 143.23 | -0.03 |
| macd_bfq | -97.03 | 100.56 | 0.00 |
| ma_bfq_5 | 0.15 | 2471.45 | 17.81 |
| ma_bfq_20 | 0.39 | 2255.11 | 17.74 |
| boll_mid_bfq | 0.39 | 2255.11 | 17.74 |

**结论**: MACD指标均值接近0符合预期，MA和BOLL值域合理

---

## 六、时间连续性检查

### 6.1 cyq_perf 时间连续性 (抽样100只股票)

| 指标 | 值 |
|------|-----|
| 样本股票数 | 100 |
| 存在缺口的股票数 | 100 |
| 最小缺口天数 | 1 |
| 最大缺口天数 | 692 |
| 平均缺口天数 | 26.06 |

**说明**: 缺口主要来自:
1. 新股上市日期晚于数据起始日期
2. 停牌期间无数据
3. 部分交易日数据缺失

### 6.2 stk_factor_pro 时间连续性 (抽样100只股票)

| 指标 | 值 |
|------|-----|
| 样本股票数 | 100 |
| 存在缺口的股票数 | 100 |
| 最小缺口天数 | 44 |
| 最大缺口天数 | 3,672 |
| 平均缺口天数 | 455.86 |

**说明**: 缺口较大主要因为:
1. 数据更新滞后(最新数据仅到20250714)
2. 新股上市日期各不相同
3. 数据覆盖时间跨度长(25年)

---

## 七、与daily表对齐情况

### 7.1 记录数对比

| 对比项 | 记录数 | daily同期记录数 | 覆盖率 |
|--------|--------|-----------------|--------|
| cyq_perf | 8,629,539 | 8,920,813 | 96.73% |
| stk_factor_pro | 14,870,710 | 15,747,358 | 94.43% |

### 7.2 数据时效性

| 表名 | 最新日期 | 距今天数 | 状态 |
|------|----------|----------|------|
| daily | 20260130 | 1天 | 最新 |
| cyq_perf | 20260130 | 1天 | 最新 |
| cyq_chips | 20251017 | 106天 | **严重滞后** |
| stk_factor_pro | 20250714 | 201天 | **严重滞后** |

---

## 八、数据分布统计

### 8.1 股票市场分布 (cyq_perf)

| 交易所 | 股票数量 | 占比 |
|--------|----------|------|
| SZ (深交所) | 2,888 | 50.4% |
| SH (上交所) | 2,308 | 40.3% |
| BJ (北交所) | 535 | 9.3% |

### 8.2 cyq_chips 每日数据密度

| 日期 | 股票数 | 记录数 | 平均价格点/股 |
|------|--------|--------|---------------|
| 20251017 | 5,430 | 547,189 | ~100.8 |
| 20251016 | 5,428 | 546,482 | ~100.7 |
| 20251015 | 5,424 | 546,974 | ~100.8 |

**说明**: 每只股票平均约100个价格点的筹码分布数据

---

## 九、问题汇总与建议

### 9.1 关键问题

| 问题等级 | 问题描述 | 影响范围 | 建议措施 |
|----------|----------|----------|----------|
| **严重** | cyq_chips 数据滞后106天 | 全表 | 及时更新数据采集任务 |
| **严重** | stk_factor_pro 数据滞后201天 | 全表 | 检查数据源接口状态 |
| **中等** | 9,232条筹码占比总和异常 | 1.73%记录 | 数据清洗或标记 |
| **中等** | 6,550条winner_rate超过100% | 0.076%记录 | 数据截断处理 |
| **轻微** | 181条price=0记录 | 个别股票 | 排查数据源 |
| **轻微** | 22条cost分位数为0 | 极少量 | 标记异常 |

### 9.2 数据质量评估

| 维度 | 评分 | 说明 |
|------|------|------|
| 完整性 | B+ | 空值率低，但时间覆盖有缺口 |
| 一致性 | A- | 成本递增逻辑正确，少量获利率越界 |
| 准确性 | B | 存在占比总和异常、价格为0等问题 |
| 时效性 | C | cyq_chips和stk_factor_pro严重滞后 |
| 唯一性 | A | 无重复数据 |

### 9.3 后续建议

1. **紧急**: 恢复 cyq_chips 和 stk_factor_pro 的数据采集任务
2. **高优先**: 对 winner_rate > 100 的数据进行截断处理: `winner_rate = MIN(winner_rate, 100)`
3. **中优先**: 排查 688063.SH 筹码占比约200%的问题，可能需要去重
4. **低优先**: 标记 price=0 和 cost=0 的异常记录

---

## 附录: 异常数据样本

### A1. price=0 异常记录

```
ts_code    | trade_date | price | percent
600436.SH  | 20250930   | 0.0   | 0.01
600436.SH  | 20250929   | 0.0   | 0.01
600436.SH  | 20250926   | 0.0   | 0.01
...
```

### A2. winner_rate > 100 异常记录

```
ts_code    | trade_date | winner_rate | weight_avg | cost_50pct
300206.SZ  | 20200707   | 100.62      | 18.63      | 18.4
000921.SZ  | 20230417   | 100.59      | 19.83      | 20.0
603813.SH  | 20260112   | 100.58      | 41.51      | 42.4
...
```

### A3. 筹码占比过低异常

```
ts_code    | trade_date | total_percent
002639.SZ  | 20241220   | 0.01
002780.SZ  | 20240510   | 0.01
002528.SZ  | 20250609   | 0.01
...
```

---

*报告完成*
