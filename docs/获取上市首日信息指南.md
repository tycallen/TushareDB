# 获取所有A股上市首日信息指南

## 概述

本指南介绍如何利用 Tushare-DuckDB 项目获取所有A股（包括已退市股票）的上市首日信息。主要包括两部分数据：
1. **股票基本信息**：包含股票代码、名称、上市日期、市场等
2. **上市首日交易数据**：包含开盘价、收盘价、最高价、最低价、成交量等

## 数据来源

上市首日信息来自于两个 Tushare 接口：
- `stock_basic`: 提供股票基本信息，包括 `list_date`（上市日期）字段
- `pro_bar`: 提供日线行情数据，可以查询特定日期的交易数据

## 快速开始

### 方法一：使用提供的脚本（推荐）

我们提供了完整的示例脚本 [`scripts/get_listing_first_day_info.py`](../scripts/get_listing_first_day_info.py)，可以直接运行：

```bash
# 进入项目目录
cd Tushare-DuckDB

# 运行脚本（默认处理 10 只股票作为示例）
python scripts/get_listing_first_day_info.py
```

**输出结果**：
- 控制台输出统计信息和处理进度
- 生成 CSV 文件（如 `listing_first_day_data_20241120_143000.csv`）

### 方法二：自定义代码实现

如果您需要在自己的项目中集成此功能，可以参考以下代码：

```python
from tushare_db import DataReader, DataDownloader

# 1. 初始化
reader = DataReader()
downloader = DataDownloader()

# 2. 获取所有股票基本信息（含上市日期）
stocks = reader.query("""
    SELECT ts_code, name, list_date, market, list_status 
    FROM stock_basic
    WHERE list_date IS NOT NULL
    ORDER BY list_date
""")

print(f"共 {len(stocks)} 只股票")

# 3. 获取特定股票的上市首日数据
for _, stock in stocks.head(10).iterrows():  # 示例：处理前10只
    ts_code = stock['ts_code']
    list_date = stock['list_date']
    
    # 查询上市首日行情
    first_day_data = reader.get_stock_daily(
        ts_code=ts_code,
        start_date=list_date,
        end_date=list_date
    )
    
    if not first_day_data.empty:
        print(f"{stock['name']} ({ts_code})")
        print(f"  上市日期: {list_date}")
        print(f"  开盘价: {first_day_data.iloc[0]['open']}")
        print(f"  收盘价: {first_day_data.iloc[0]['close']}")
        print(f"  涨跌幅: {((first_day_data.iloc[0]['close'] / first_day_data.iloc[0]['open'] - 1) * 100):.2f}%")

# 4. 关闭连接
reader.close()
downloader.close()
```

## 详细步骤说明

### 步骤 1: 下载股票基本信息

首先需要确保数据库中有股票基本信息，包括上市股票和退市股票：

```python
from tushare_db import DataDownloader

downloader = DataDownloader()

# 下载上市股票
downloader.download_stock_basic('L')

# 下载退市股票
downloader.download_stock_basic('D')

downloader.close()
```

**参数说明**：
- `'L'` = Listed（上市）
- `'D'` = Delisted（退市）
- `'P'` = Paused（暂停上市）

### 步骤 2: 查询股票列表

```python
from tushare_db import DataReader

reader = DataReader()

# 方式 1: 获取所有股票（不区分状态）
all_stocks = reader.get_stock_basic(list_status=None)

# 方式 2: 使用 SQL 查询（更灵活）
stocks = reader.query("""
    SELECT 
        ts_code,
        name,
        list_date,
        market,
        list_status
    FROM stock_basic
    WHERE list_date IS NOT NULL
    ORDER BY list_date
""")

reader.close()
```

**返回字段**：
- `ts_code`: 股票代码（如 `000001.SZ`）
- `name`: 股票名称（如 `平安银行`）
- `list_date`: 上市日期（YYYYMMDD 格式，如 `19910403`）
- `market`: 市场（主板、创业板、科创板等）
- `list_status`: 上市状态（L/D/P）

### 步骤 3: 获取上市首日交易数据

```python
from tushare_db import DataReader

reader = DataReader()

ts_code = '000001.SZ'  # 平安银行
list_date = '19910403'  # 上市日期

# 查询上市首日数据
first_day_data = reader.get_stock_daily(
    ts_code=ts_code,
    start_date=list_date,
    end_date=list_date,
    adj=None  # 不复权（上市首日无需复权）
)

if not first_day_data.empty:
    print(first_day_data)
    # 输出包含: open, high, low, close, vol, amount 等字段

reader.close()
```

### 步骤 4: 批量处理与导出

```python
import pandas as pd
from tushare_db import DataReader

reader = DataReader()

# 获取所有股票
stocks = reader.query("SELECT ts_code, name, list_date FROM stock_basic WHERE list_date IS NOT NULL")

results = []

for _, stock in stocks.iterrows():
    ts_code = stock['ts_code']
    list_date = stock['list_date']
    
    # 查询首日数据
    first_day = reader.get_stock_daily(ts_code, list_date, list_date)
    
    if not first_day.empty:
        results.append({
            'ts_code': ts_code,
            'name': stock['name'],
            'list_date': list_date,
            'open': first_day.iloc[0]['open'],
            'close': first_day.iloc[0]['close'],
            'high': first_day.iloc[0]['high'],
            'low': first_day.iloc[0]['low'],
            'vol': first_day.iloc[0]['vol'],
            'amount': first_day.iloc[0]['amount'],
        })

# 转换为 DataFrame
result_df = pd.DataFrame(results)

# 导出到 CSV
result_df.to_csv('listing_first_day_info.csv', index=False, encoding='utf-8-sig')

reader.close()
```

## 注意事项

### 1. 数据缺失问题

部分股票的上市首日可能没有交易数据，原因包括：
- 历史数据缺失（特别是早期上市的股票）
- 上市首日恰好是休市日（极少见）
- 数据尚未下载

**解决方案**：
```python
# 如果本地数据库没有，尝试从 Tushare 下载
if first_day_data.empty:
    downloader.download_stock_daily(ts_code, list_date, list_date)
    # 重新查询
    first_day_data = reader.get_stock_daily(ts_code, list_date, list_date)
```

### 2. 性能优化建议

处理全部股票（5000+）可能需要较长时间，建议：

**方案 1**: 分批处理
```python
# 按市场分批
markets = ['主板', '创业板', '科创板', '北交所']
for market in markets:
    stocks = reader.query(f"SELECT * FROM stock_basic WHERE market = '{market}'")
    # 处理该市场的股票...
```

**方案 2**: 使用多进程
```python
from multiprocessing import Pool

def process_stock(stock_info):
    # 处理单只股票
    pass

with Pool(4) as pool:
    results = pool.map(process_stock, stocks.to_dict('records'))
```

**方案 3**: 增量更新
```python
# 只处理新上市的股票
last_processed_date = '20230101'  # 上次处理的日期
new_stocks = reader.query(f"""
    SELECT * FROM stock_basic 
    WHERE list_date > '{last_processed_date}'
""")
```

### 3. 数据库表结构兼容性

不同版本的数据库可能字段不同，建议先检查：

```python
# 检查可用字段
reader = DataReader()
columns = reader.db.get_table_columns('stock_basic')
print("可用字段:", columns)

# 动态构建查询
if 'list_status' in columns:
    query = "SELECT * FROM stock_basic WHERE list_status IN ('L', 'D')"
else:
    query = "SELECT * FROM stock_basic"
```

## 数据字段说明

### stock_basic 表（股票基本信息）

| 字段 | 类型 | 说明 |
|------|------|------|
| ts_code | VARCHAR | 股票代码（如 000001.SZ） |
| symbol | VARCHAR | 股票代码（不含后缀） |
| name | VARCHAR | 股票名称 |
| list_date | VARCHAR | 上市日期（YYYYMMDD） |
| market | VARCHAR | 市场（主板/创业板/科创板/北交所） |
| list_status | VARCHAR | 上市状态（L=上市/D=退市/P=暂停） |
| exchange | VARCHAR | 交易所（SSE/SZSE） |

### pro_bar 表（日线行情）

| 字段 | 类型 | 说明 |
|------|------|------|
| ts_code | VARCHAR | 股票代码 |
| trade_date | VARCHAR | 交易日期（YYYYMMDD） |
| open | DOUBLE | 开盘价 |
| high | DOUBLE | 最高价 |
| low | DOUBLE | 最低价 |
| close | DOUBLE | 收盘价 |
| pre_close | DOUBLE | 昨收价 |
| vol | DOUBLE | 成交量（手） |
| amount | DOUBLE | 成交额（千元） |

## 常见应用场景

### 场景 1: 分析上市首日涨跌幅分布

```python
# 计算涨跌幅
result_df['change_pct'] = (result_df['close'] / result_df['open'] - 1) * 100

# 统计分析
print(f"平均涨跌幅: {result_df['change_pct'].mean():.2f}%")
print(f"最大涨幅: {result_df['change_pct'].max():.2f}%")
print(f"最大跌幅: {result_df['change_pct'].min():.2f}%")

# 可视化
import matplotlib.pyplot as plt
result_df['change_pct'].hist(bins=50)
plt.title('上市首日涨跌幅分布')
plt.xlabel('涨跌幅 (%)')
plt.show()
```

### 场景 2: 按年份统计上市情况

```python
# 提取年份
result_df['year'] = result_df['list_date'].str[:4]

# 按年份统计
yearly_stats = result_df.groupby('year').agg({
    'ts_code': 'count',
    'change_pct': 'mean'
}).rename(columns={'ts_code': '上市数量', 'change_pct': '平均涨跌幅'})

print(yearly_stats)
```

### 场景 3: 筛选特定条件的股票

```python
# 示例：找出上市首日涨幅超过 100% 的股票
high_gain_stocks = result_df[result_df['change_pct'] > 100]
print(f"上市首日涨超 100% 的股票: {len(high_gain_stocks)} 只")
print(high_gain_stocks[['name', 'list_date', 'change_pct']])
```

## Web API 使用

如果您启动了项目的 Web API 服务，也可以通过 HTTP 请求获取数据：

```bash
# 启动 Web 服务
uvicorn src.tushare_db.web_server:app --host 0.0.0.0 --port 8000

# 查询股票基本信息
curl "http://localhost:8000/api/stock_basic"

# 查询特定股票的上市首日数据
curl "http://localhost:8000/api/pro_bar?ts_code=000001.SZ&start_date=19910403&end_date=19910403"
```

## 总结

使用 Tushare-DuckDB 项目获取上市首日信息的完整流程：

1. **下载基础数据**：使用 `DataDownloader` 下载 `stock_basic` 表
2. **查询股票列表**：使用 `DataReader` 获取所有股票及上市日期
3. **获取首日数据**：循环查询每只股票的上市首日行情
4. **数据处理与导出**：合并数据并导出为 CSV 或进行分析

完整示例代码请参考：[`scripts/get_listing_first_day_info.py`](../scripts/get_listing_first_day_info.py)

## 参考资料

- [项目 README](../README.md)
- [API 参考文档](../API_REFERENCE_FOR_LLM.md)
- [快速开始指南](../QUICK_START.md)
- [Tushare Pro 官方文档](https://tushare.pro/document/2)
